<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}PF Planner{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

<header class="bg-white dark:bg-gray-800 shadow p-4 flex justify-between items-center">
    <a href="/" class="text-xl font-bold hover:underline">
        PF Planner
    </a>


    <!-- Mobile menu button -->
    <button 
        class="md:hidden p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"
        onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Desktop nav -->
    <nav class="hidden md:flex space-x-4">
        {% if config.AUTH_ENABLED and config.AUTH_STRATEGY != 'noauth' %}
        <a href="{{ url_for('account.account_home') }}" class="hover:underline">My Account</a>
        <a href="{{ url_for('auth.logout') }}" class="hover:underline">Logout</a>
        {% endif %}
        <a href="{{ url_for('settings.settings_home') }}" class="hover:underline">Settings</a>
        <a href="{{ url_for('contact.contact_home') }}" class="hover:underline">Contact</a>
        <button onclick="toggleDarkMode()" class="px-3 py-1 border rounded text-sm">Dark Mode</button>
    </nav>
</header>

<!-- Mobile nav -->
<nav id="mobile-menu" class="md:hidden hidden flex flex-col space-y-2 p-4 bg-white dark:bg-gray-800 shadow">
    {% if config.AUTH_ENABLED and config.AUTH_STRATEGY != 'noauth' %}
    <a href="{{ url_for('account.account_home') }}" class="hover:underline">My Account</a>
    <a href="{{ url_for('auth.logout') }}" class="hover:underline">Logout</a>
    {% endif %}
    <a href="{{ url_for('settings.settings_home') }}" class="hover:underline">Settings</a>
    <a href="{{ url_for('contact.contact_home') }}" class="hover:underline">Contact</a>
    <button onclick="toggleDarkMode()" class="px-3 py-1 border rounded text-sm w-32">Dark Mode</button>
</nav>


<main class="flex-grow p-6">
    {% if session.nav_stack and session.nav_stack|length > 1 %}
        <a href="{{ url_for('go_back') }}" class="back-button">Back</a>
    {% endif %}
    {% block content %}{% endblock %}
</main>

<footer class="p-4 text-center text-sm text-gray-500 dark:text-gray-400">
    PF Planner Â© {{ current_year }}
</footer>

<script>
    /* -------------------------------
       DARK MODE
    --------------------------------*/
    if (localStorage.getItem("theme") === "dark") {
        document.documentElement.classList.add("dark");
    }

    function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    /* -------------------------------
       HELPER: sanitize numeric string
       - keep digits and at most one dot
    --------------------------------*/
    function sanitizeNumericString(value) {
        if (!value) return "";

        // Remove everything except digits and dots
        let cleaned = value.replace(/[^0-9.]/g, "");

        // If multiple dots, keep only the first
        const firstDot = cleaned.indexOf(".");
        if (firstDot !== -1) {
            const before = cleaned.slice(0, firstDot + 1);
            const after = cleaned.slice(firstDot + 1).replace(/\./g, "");
            cleaned = before + after;
        }

        return cleaned;
    }

    /* -------------------------------
       REAL-TIME SANITIZATION + FORMATTING
       This alone should enforce numeric-only,
       even if keydown behaves oddly.
    --------------------------------*/
    document.addEventListener("input", function (e) {
        const el = e.target;

        if (el.classList.contains("money-input") || el.classList.contains("term-input")) {
            let raw = sanitizeNumericString(el.value);
            if (raw === "") {
                el.value = "";
                return;
            }
            const num = Number(raw);
            el.value = Number.isNaN(num) ? "" : num.toLocaleString("en-US");
        }

        if (el.classList.contains("percent-input")) {
            let raw = sanitizeNumericString(el.value);
            el.value = raw;
        }
    });

    /* -------------------------------
       OPTIONAL: block obvious bad keys
       (input handler is still the final gatekeeper)
    --------------------------------*/
    document.addEventListener("keydown", function (e) {
        const el = e.target;

        if (el.classList.contains("money-input") || el.classList.contains("percent-input")  || el.classList.contains("term-input")) {
            const allowedKeys = [
                "Backspace", "Delete", "ArrowLeft", "ArrowRight",
                "Tab", "Home", "End"
            ];

            if (allowedKeys.includes(e.key)) return;

            // Allow one decimal point
            if (e.key === "." && !el.value.includes(".")) return;

            // If key is a single digit, allow it
            if (/^[0-9]$/.test(e.key)) return;

            // Everything else: block
            e.preventDefault();
        }
    });

    /* -------------------------------
       SANITIZE PASTE
    --------------------------------*/
    document.addEventListener("paste", function (e) {
        const el = e.target;

        if (el.classList.contains("money-input") || el.classList.contains("percent-input") || el.classList.contains("term-input")) {
            e.preventDefault();
            let text = (e.clipboardData || window.clipboardData).getData("text") || "";
            el.value = sanitizeNumericString(text);
            el.dispatchEvent(new Event("input", { bubbles: true }));
        }
    });
</script>

</body>
</html>